---
title: "Punctate Report"
author: "David McGaughey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_notebook:
    theme: flatly
    toc: true
---

Identifying genes with the following characteristics:
  - 2 or more sum ATAC-peaks in GFP versus iPSC in the 1000bp and 5000bp upstream windows
  - Changes in RNA expression between GFP and iPSC of abs(log2(TPM+1)) > 2

```{r, fig.height=2.5, fig.width=4}
library(tidyverse)
library(ComplexHeatmap)
library(viridis)
library(circlize)
library(annotables)
#peak <- read_tsv('/Volumes/data/projects/nei/hufnagel/iPSC_RPE_ATAC_Seq/peak_full/homer_GFP__not__IPSC/all/all_common_peaks.blackListed.narrowPeak.closestTSS__interesting_homer_motif.bed.gz')
expression <- read_csv('~/git/ipsc_rpe_RNA-seq/data/lsTPM_by_Line_with_Diff_Exp.tsv')
cgm_gfp <- read_tsv('/Volumes/data/projects/nei/hufnagel/iPSC_RPE_ATAC_Seq/CGM/GFP_common_peaks.blackListed.narrowPeak.CGM.tsv') %>% 
  left_join(. , expression %>% filter(Line == 'GFP') %>% select(Gene, lsTPM), by = c('Gene_Name' = 'Gene'))
cgm_ipsc <- read_tsv('/Volumes/data/projects/nei/hufnagel/iPSC_RPE_ATAC_Seq/CGM/IPSC_common_peaks.blackListed.narrowPeak.CGM.tsv') %>% 
  left_join(. , expression %>% filter(Line == 'iPSC') %>% select(Gene, lsTPM), by = c('Gene_Name' = 'Gene'))
cgm_rfp <-  read_tsv('/Volumes/data/projects/nei/hufnagel/iPSC_RPE_ATAC_Seq/CGM/RFP_common_peaks.blackListed.narrowPeak.CGM.tsv')  %>% 
  left_join(. , expression %>% filter(Line == 'RFP') %>% select(Gene, lsTPM), by = c('Gene_Name' = 'Gene'))

delta_cgm <- (cgm_gfp %>% mutate(`log2(TPM+1)` = log2(lsTPM+1)) %>%  select(Exon_Count:Gene_length, `log2(TPM+1)`)) - (cgm_ipsc %>% mutate(`log2(TPM+1)` = log2(lsTPM+1)) %>% select(Exon_Count:Gene_length, `log2(TPM+1)`)) %>% as.tibble()
delta_cgm$Gene_Name = cgm_gfp$Gene_Name
#delta_cgm$var <- apply(delta_cgm %>% select(Exon_Count:`-1e6`), 1, var)

punctate_upstream <- delta_cgm %>% mutate(`5k_upstream` = `5000` + `1000`) %>% 
  filter(`5k_upstream` > 1, abs(`log2(TPM+1)`) > 2) 
punctate_upstream %>% left_join(., grch38 %>% select(symbol, description), by = c("Gene_Name" = "symbol")) %>% 
  select(Gene_Name, description, `log2(TPM+1)`, Exon_Count:`-1e6`) %>% 
  DT::datatable()
row.names(punctate_upstream) <- punctate_upstream$Gene_Name  
punctate_upstream <- punctate_upstream %>% select(`1e6`:`-1e6`, `log2(TPM+1)`)
atac_heatmap <- punctate_upstream %>% select(-`log2(TPM+1)`) %>% 
  Heatmap(col = colorRamp2(c(-4, 0, 4), viridis(3)),
          cluster_columns = F,
          name = 'Number of Peaks in Window GFP <-> RFP',
          show_row_names = F)
expression_heatmap <- punctate_upstream %>% select(`log2(TPM+1)`) %>% 
  Heatmap(col = colorRamp2(c(-6, 0, 6), viridis(3)),
          cluster_columns = F,
          name = 'log2(TPM+1) Delta GFP <-> RFP')
atac_heatmap + expression_heatmap
```

